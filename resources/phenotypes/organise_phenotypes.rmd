---
title: "Phenotype organisation"
date: "`r Sys.Date()`"
output: html_document
---

TO DO:

- update remove outliers code
- tidy up code to make html readable
- make sure input and output files match other parts of pipeline
- update envronment output


Files needed to input into this:
 - environment
 - ancestry - currently id and ancestry from ancestry file
 - genetic covariates (id, PC's)
 - phenotype file (id, age, phenotype value)
 - phenotype covariates (id,  year of birth, sex)
 
This all may need to be updated based on the output from the genetic processing

Files output from this file:
 - in phenotype processed folder: file for each GWAS with naming convention 'phenotype'_'ancestry'_('agebin']_pheno_dat.rds
 - in results folder: file of summary data for each phenotype with naming convention 'phenotype'_summary.rds


Other notes:

What format does sex need to be in? - currently specified at the begninning to be added to the enviroment file
Currently drops anything with NA rather than being specific to the variables of interest
Age is assumed to be in years

Install required packages
```{r}
if (!require(quantreg)) install.packages("quantreg", repos="https://cloud.r-project.org")
library(quantreg)
if (!require(rms)) install.packages("rms", repos="https://cloud.r-project.org")
library(rms)
```


```{r}
library(git2r)
library(dplyr)
library(jsonlite)
library(ggplot2)
library(data.table)
library(here)
library(rmarkdown)
library(dotenv)
```

Read config file

-- this has changed to .env
will need to change to Sys.getenv everywhere that config$ appears. 

```{r}
readRenviron(here("config-template.env"))
```

#set up output directories
```{r}
dir.create(Sys.getenv("results_dir"), showWarnings = FALSE)
dir.create(Sys.getenv("phenotype_processed_dir"), showWarnings = FALSE)

```

# Source R functions file

Move this to be in the resources file
Use package 'here' - gives directory path to root directory. 

```{r}
source(here("resources", "phenotypes", "phenotype_functions.R"))
```

# Data input

Read in phenotype names and outlier removal parameters

```{r}
df <- read.csv(file.path(Sys.getenv("phenotype_input_dir"), "phenotype_list.csv"))
names(df)

phenotypes <- df["pheno_id"]
```

## Ancestry 
read in ancestry file

```{r}
ancestry <- fread(file.path(Sys.getenv("genotype_input_dir"), "ancestry.txt"))
names(df)
```

## Covariates
read in PC's file

```{r}
gen_covs <- fread(file.path(Sys.getenv("genotype_input_dir"), "gen_covariates.txt"))
names(gen_covs)
```

## Currently assuming that sex appears in the phenotype covariates file

```{r}
phen_covs <- fread(file.path(Sys.getenv("phenotype_input_dir"), "pheno_covariates.txt"))
names(phen_covs)
```


# Summarise data
Now run by phenotype 

Steps (for each phenotype):
 - merge together files and remove NA's
 - summarise age and ancestry distribution
 - and overall phenotype by age
 - break up file by age/ancestry - decide whether to keep based on min sample size in config - report sample sizes for groups being dropped
 - remove outliers 
 - summarise phenotype, dec.o.b and sex
 - save files by age and ancestry

note currently just for BMI but will need to loop over all phenotypes

```{r}

for(i in 1:length(phenotypes$pheno_id)){
  phecode <- phenotypes[i,1]
  print(phecode)

cs <- list()

phen <- read_phenotype_data(phecode, Sys.getenv("phenotype_input_dir")) 


if(!is.null(phen)){ 
  
  #add check that don't have multiple genetic observations per person, or covariate observations 
  
#  triCATCH
  
dat <- phen %>%
  left_join(phen_covs, by = "id") %>% 
  left_join(gen_covs, by = "id") %>%
  left_join(ancestry, by = "id") %>%
  na.exclude

##age and ancestry distribution
hist(dat$age, breaks=length(unique(round(dat$age))))
cs$age_summary <- summary(dat$age)
cs$ancestry <- table(dat$ancestry)
cs$ancestry

ancestry_list <- unique(dat$ancestry) 
for(a in 1:length(ancestry_list)){
  a_group <- ancestry_list[a]
  print(a_group)
  dat_temp <- subset(dat, dat$ancestry == a_group)
  print(plot_phen_all(dat_temp, phecode))
  print(plot_phen_traj(dat_temp, phecode))
}

rm(dat_temp)

#decade of birth - currently across all data rather than by GWAS sample
dat$deob <- cut(dat$yob/10, breaks=seq(190,203, by=1))
cs$deob_summary <- table(dat$deob)
cs$deob_summary

hist(dat$yob, breaks=length(unique(round(dat$yob))))

#sex for the whole sample, and tablulated by year of birth
cs$sex_table <- table(dat$sex)
cs$sex_table

cs$sex_yob <- dat %>% 
    group_by(sex) %>% 
    summarise(
        yob_mean = mean(yob, na.rm=T), 
        yob_sd = sd(yob, na.rm=T)
    )
cs$sex_yob


#counts of sample size in each age group
cats <- dat %>% group_by(agebin, ancestry) %>%
  summarize(n())
colnames(cats) <- c("agebin", "ancestry", "n")

cs$categories <- cats 

cats <- filter(cats, n >= Sys.getenv("env_minumum_strat_n"))
analysis_data <- inner_join(dat, cats, by = c("agebin", "ancestry"))

ancestry_list_filtered <- unique(analysis_data$ancestry)
age_list_filtered <- unique(analysis_data$agebin)

summary_output <- tibble()

for(k in 1:length(ancestry_list_filtered)){
  for(l in 1:length(age_list_filtered)){
  
  anc_group <- ancestry_list_filtered[k]
  age_group <- age_list_filtered[l]
  
  pheno_out <- filter(analysis_data, (agebin == age_group) & (ancestry == anc_group))
  outliers <- detect_outliers(pheno_out, phecode)
  
  pheno_out <- remove_outliers(pheno_out, phecode)
  
  pheno_out$winsorised <- mbw(MBW_Y=pheno_out$value,MBW_X=pheno_out$age, knots=5, multiple=1,lpc=0.005, upc=0.995, plotme="show", comparator=0)
  
  
  saveRDS('pheno_out', file=file.path(Sys.getenv("phenotype_processed_dir"), paste(phecode, paste(anc_group, paste(age_group,"pheno_dat.rds",sep="_"), sep="_"), sep = "_")))            
  sumstats <- summarise_phen(pheno_out, age_group, anc_group)
  summary_output <- rbind(summary_output,cbind(anc_group, age_group, length(outliers$value), sumstats))
  
  }
 
}
    cs$sums <- summary_output

saveRDS(cs, file=file.path(Sys.getenv("results_dir"), paste(phecode,"summary.rds",sep="_")))
}
}
```



assign(paste(phecode,"outlier_rm",sep="_"), remove_outliers(phen, phecode))




```



## Run details

Get git version

```{r}
g <- git2r::revparse_single(here(), "HEAD")
g
```

Session info

```{r}
sessionInfo()
```