---
title: "Phenotype organisation"
date: "`r Sys.Date()`"
output: html_document
---

4/1/24:
Update spreadsheet
Merge into main branch
Run alspac through this file



TO DO:

- update windsorizing to not use age if age range <=2 
- make sure input and output files match other parts of pipeline
- update environment output


Files needed to input into this:
 - environment
 - phenotype description (name, id, type, units, min, max)
 - genetic covariates (id, PC's)
 - phenotype file (id, age, phenotype value)
 - phenotype covariates (id,  year of birth, sex). #NB - it doesnt actually matter if sex appears in covariates file
 
This all may need to be updated based on the output from the genetic processing

Files output from this file:
 - in phenotype processed folder: file for each GWAS with naming convention phen_'phenotype'_('agebin']_pheno_dat.rds
 - in results folder: file of summary data for each phenotype with naming convention 'phenotype'_summary.rds


Other notes:

If running script for multiple ancestries will need to specify this in folder structure to ensure that different ancestries aren't written over each other 
Currently drops anything with NA rather than being specific to the variables of interest
Age is assumed to be in years


```{r}
library(rms)
library(quantreg)
library(git2r)
library(dplyr)
library(ggplot2)
library(data.table)
library(here)
library(rmarkdown)
library(dotenv)
```

Read config file

```{r}
readRenviron(here("config.env"))
agebins <- fread(here("resources", "phenotypes", "agebins.csv")) %>% as_tibble()
```

#set up output directories
```{r}
dir.create(Sys.getenv("results_dir"), showWarnings = FALSE)
dir.create(Sys.getenv("phenotype_processed_dir"), showWarnings = FALSE)
```

# Source R functions file

Move this to be in the resources file
Use package 'here' - gives directory path to root directory. 

```{r}
source(here("resources", "phenotypes", "phenotype_functions.R"))
```

# Data input

Read in phenotype names and outlier removal parameters

```{r}
df <- fread(here("phenotype_list.csv")) %>% 
  as_tibble() %>%
  mutate(filepath = file.path(Sys.getenv("phenotype_input_dir"), paste0(pheno_id, ".txt"))) %>%
  filter(file.exists(filepath))
df
phenotypes <- df$pheno_id
```

## Covariates

Genetic covariates

```{r}
gen_covs <- fread(file.path(Sys.getenv("genotype_processed_dir"), paste0(Sys.getenv("bfile_prefix"), "pc.txt")))
names(gen_covs)
```

Phenotypic covariates

Expect space separated file with a header line and the following columns:

- `FID` - family identified (can be same as `IID`)
- `IID` - individual identifier
- `sex` - sex
- `yob` - year of birth (optional)
- `parity` - parity (optional)
- `bp_med`
- `cholesterol_med`
- any other covariates to be included

```{r}
phen_covs <- fread(file.path(Sys.getenv("phenotype_input_dir"), "pheno_covariates.txt"))
names(phen_covs)
```

Organising covariates

- For every trait identify the covariates that are required from the csv file
- Create that cov file
- For every trait create the cov-quan, cov-qual and the phen file
- GCTA will use both cov-quan and cov-qual


# Summarise data

Now run by phenotype 

Steps (for each phenotype):
 - merge together files and remove NA's
 - summarise age and ancestry distribution
 - and overall phenotype by age
 - break up file by age/ancestry - decide whether to keep based on min sample size in config - report sample sizes for groups being dropped
 - remove outliers 
 - summarise phenotype, dec.o.b and sex
 - save files by age and ancestry

note currently just for BMI but will need to loop over all phenotypes



```{r}
for(i in 1:length(phenotypes)){
  phecode <- phenotypes[i]
  print(phecode)
  type <- filter(df, pheno_id == phecode)$var_type
  print(type)
  cs <- list()
  phen <- read_phenotype_data(phecode, Sys.getenv("phenotype_input_dir"), agebins)
  
  if(is.null(phen)) {
    return(NULL)
  }
  
  #add check that don't have multiple genetic observations per person, or covariate observations 
  #  triCATCH
  
  dat <- phen %>%
    left_join(gen_covs, by = c("FID", "IID")) %>%
    left_join(phen_covs, by = c("FID", "IID")) %>% 
    na.exclude

  ##age and ancestry distribution
  hist(dat$age, breaks=length(unique(round(dat$age))))
  cs$age_summary <- summary(dat$age)
  cs$age_quantile <- dat$age %>% quantile(probs=seq(0, 1, 0.01))

  print(plot_phen_all(dat, phecode))
  print(plot_phen_traj(dat, phecode))

  dat$deob <- cut(dat$yob/10, breaks=seq(190,203, by=1))
  cs$deob_summary <- table(dat$deob)
  cs$deob_summary

  hist(dat$yob, breaks=length(unique(round(dat$yob))))

  cs$sex_table <- table(dat$sex)
  cs$sex_table

  cs$sex_yob <- dat %>% 
    group_by(sex) %>% 
    summarise(
        yob_mean = mean(yob, na.rm=T), 
        yob_sd = sd(yob, na.rm=T)
    )
  cs$sex_yob


  #remove outliers and windsorize if exposure is continuous, use function if age range >2 otherwise just apply standard windsorizing 

  outliers <- detect_outliers(dat, phecode)
  analysis_data <- remove_outliers(dat, phecode)

  age_range = max(dat$age) - min(dat$age)

  if(type == "cont"){
      out <- mbw(MBW_Y=dat$value,MBW_X=dat$age, knots=5, multiple=1,lpc=0.005, upc=0.995, plotme="show", comparator=0)
      dat$value <- out
  }

  #counts of sample size in each age group
  cats <- dat %>% group_by(agebin) %>%
    summarize(n())
  colnames(cats) <- c("agebin", "n")

  cs$categories <- cats 

  cats <- filter(cats, n >= as.numeric(Sys.getenv("env_minumum_strat_n")))
  analysis_data <- inner_join(dat, cats, by = c("agebin"))

  summary_output <- list()

  for(k in 1:length(cats$n)){
    
    age_group <- cats$agebin[k]
    pheno_out <- filter(analysis_data, (agebin == cats$agebin[k])) %>% filter(!duplicated(paste(FID, IID))) %>% select(FID, IID, value)
    write.table(pheno_out, file=file.path(Sys.getenv("phenotype_processed_dir"), paste0(phecode, "_", age_group, ".phen")), row=FALSE, col=FALSE, qu=FALSE)

    cov_ids <- subset(df, pheno_id == phecode)$covs %>% strsplit(., ":") %>% {.[[1]]}
    covs <- dat %>% select(all_of(c(names(gen_covs), cov_ids))) %>% filter(IID %in% pheno_out$IID) %>% filter(!duplicated(paste(FID, IID)))
    write.table(covs, file=file.path(Sys.getenv("phenotype_processed_dir"), paste0(phecode, "_", age_group, ".covs")), row=FALSE, col=FALSE, qu=FALSE)
   
    sumstats <- summarise_phen(pheno_out, cats$agebin[k])
    summary_output[[k]] <- cbind(age_group, length(outliers$value), sumstats)
  }
  cs$sums <- bind_rows(summary_output)
  print(cs$sums)


  #counts of sample size in each lifestage group
  catsls <- dat %>% group_by(lsbin) %>%
    summarize(n())
  colnames(catsls) <- c("lsbin", "n")

  cs$categories_ls <- catsls

  catsls <- filter(catsls, n >= as.numeric(Sys.getenv("env_minumum_strat_n")))
  analysis_data <- inner_join(dat, catsls, by = c("lsbin"))

  summary_output <- list()

  for(k in 1:length(catsls$n)){
    
    age_group <- catsls$lsbin[k]
    pheno_out <- filter(analysis_data, (lsbin == catsls$lsbin[k])) %>% filter(!duplicated(paste(FID, IID))) %>% select(FID, IID, value)
    write.table(pheno_out, file=file.path(Sys.getenv("phenotype_processed_dir"), paste0(phecode, "_", age_group, ".phen")), row=FALSE, col=FALSE, qu=FALSE)

    cov_ids <- subset(df, pheno_id == phecode)$covs %>% strsplit(., ":") %>% {.[[1]]}
    covs <- dat %>% select(all_of(c(names(gen_covs), cov_ids))) %>% filter(IID %in% pheno_out$IID) %>% filter(!duplicated(paste(FID, IID)))
    write.table(covs, file=file.path(Sys.getenv("phenotype_processed_dir"), paste0(phecode, "_", age_group, ".covs")), row=FALSE, col=FALSE, qu=FALSE)
   
    sumstats <- summarise_phen(pheno_out, catsls$lsbin[k])
    summary_output[[k]] <- cbind(age_group, length(outliers$value), sumstats)
  }


  cs$sums_ls <- bind_rows(summary_output)
  print(cs$sums_ls)

  saveRDS(cs, file=file.path(Sys.getenv("results_dir"), "02", paste0(phecode,"_summary.rds")))
}
```

## Run details

Get git version

```{r}
g <- git2r::revparse_single(here(), "HEAD")
g
```

Session info

```{r}
sessionInfo()
```